{block head}

	<style type="text/css">
		form table {
			background-color: transparent;
		}

		.section-errors {
			border: 1px solid #808080;
			background-color: #F8F8F8;
			padding: 10px;
			margin: 20px;
		}

		.section-errors h2 {
			/*margin-top: 30px;*/
		}

		.section-errors a {
			color: #006ed3;
			text-decoration: none;
		}

		.section-errors a:hover {
			text-decoration: underline;
		}

		.section-errors abbr {
			border-bottom: none;
		}

		.section-errors li {
			list-style-type: none;
		}

		.section-errors .id {
			display: inline-block;
			min-width: 50px;
			margin-left: 5px;
		}

		.section-errors > ul {
			margin-top: 10px;
		}

		.section-errors > ul > li.message strong, .section-errors > ul > li.message abbr {
			cursor: pointer;
		}

		.section-errors li.message {
			margin-top: 20px;
			padding-top: 10px;
			border-top: 1px solid #ccc;
		}

		.section-errors > ul > li.message.highlighted {
			background-color: #444;
			color: #F8F8F8;
			-moz-border-radius: 3px;
			border-radius: 3px;
			/*margin-left: 10px;*/
			/*padding-left: 7px;*/
			/*padding-right: 7px;*/
			/*margin-right: -5px;*/
		}

		.section-errors > ul > li.message.highlighted a {
			color: inherit;
			text-decoration: underline;
		}

		.section-errors > ul > li.message.highlighted a:hover {
			color: #fff;
		}

		.section-errors > ul > li.message.highlighted small {
			color: #E0E0E0;
		}

		.section-errors > ul > li.message.highlighted .id {
			/*visibility: hidden;*/
		}

		.section-errors > ul > li.message.highlighted abbr {
			color: inherit;
		}

		.section-errors > ul > li small, .section-errors form {
			color: #808080;
			margin-left: 30px;
			font-size: 90%;
			clear: both;
			display: block;
		}

		.section-errors .to-right {
			text-align: right;
		}

		.section-errors-urls {
			display: none;
			background-color: #fff;
			font-size: 85%;
			margin-top: 10px;
			padding: 10px 0px 10px 20px;
			border-left: 2px solid #808080;
		}

		.section-errors-urls li {
			margin: 0;
		}

		.section-errors-urls a {
			color: inherit;
		}

		.section-errors a.redscreen {
			color: #c70000;
		}

		.section-errors a.resolve {
			color: #008500;
		}

		.section-errors a.resolve.reopen {
			color: #000085
		}

		.section-errors-urls a:hover {
			text-decoration: underline;
		}

		.section-errors span.today {
			color: #d60000;
			font-weight: bold;
		}

		.section-errors span.this-week {
			color: #990;
			font-weight: bold;
		}

		small.pull-right {
			float: right;
		}

		.section-errors form input[type="text"] {
			width: 50%;
		}

	</style>

{/block}

{block scripts}

	{include #parent}

	<script type="text/javascript">
		$(document).ready(function () {

			var cache = {};
			var errorBlock = $(".section-errors");

			var getMainListItem = function (errorId) {
				if (typeof cache[errorId] == "undefined") {
					cache[errorId] = errorBlock.find("#error-" + errorId);
				}
				return cache[errorId];
			};

			var getUrlsBlock = function (errorId) {
				return getMainListItem(errorId).next(".section-errors-urls");
			};

			var toggleUrlsBlock = function (errorId) {
				if (getUrlsBlock(errorId).is(":hidden")) {
					showUrlsBlock(errorId);
				} else {
					hideUrlsBlock(errorId);
				}
			};

			var hideUrlsBlock = function (errorId) {
				getUrlsBlock(errorId).hide();
				getMainListItem(errorId).find("abbr").text("►");
			};

			var showUrlsBlock = function (errorId) {
				getUrlsBlock(errorId).show();
				getMainListItem(errorId).find("abbr").text("▼");
			};

			var getErrorIdFromHash = function () {
				return location.hash.substr(1);
			};

			var highlightError = function (errorId) {
				errorBlock.find(".highlighted").removeClass("highlighted");
				if (errorId) getMainListItem(errorId).addClass("highlighted");
			};

			errorBlock.find("li.message strong, li.message abbr").click(function (e) {

				var errorId = $(this).closest("li").attr("id").substr(6);
				var urlsBlock = getUrlsBlock(errorId);

				if (urlsBlock.children().length == 0) {
					$.getJSON({link getUrls!}, { errorId: errorId }, function (payload) {

						if (!payload.urls) return false;
						var ul = urlsBlock.append("<ul>").find("ul");

						for (i = 0; i < payload.urls.length; i++) {
							var url = payload.urls[i].url;
							var count = payload.urls[i].count;
							ul.append("<li>");
							ul.find("li:last")
								.append(count + "× ")
								.append($("<a>", {
									text: url,
									href: url
								}));
						}

						showUrlsBlock(errorId);

					});

				} else {
					toggleUrlsBlock(errorId);
				}

			});

			$("a.redscreen").click(function() {
				window.open(this.href);
				return false;
			})

			$("a.resolve").click(function () {

				var link = $(this);
				var errorId = link.closest("li").attr("id");

				$.getJSON(this.href, function (payload) {

					var li = getMainListItem(errorId);
					li.css({
						color: "#ccc",
						fontStyle: "italic"
					});
					li.find("strong:first").css({
						textDecoration: "line-through",
						fontStyle: "italic"
					});
					hideUrlsBlock(errorId);
					link.remove();

				});

				return false;

			});

			$(window).bind("hashchange", function (e) {
				highlightError(location.hash.substr(7));
			});

			$(window).trigger("hashchange"); // zvýraznení při načtení stránky

		});

	</script>

{/block}

{block content}
	<h1 n:inner-block="title">Přehled zaznamenaných problémů</h1>

	<small class="pull-right">
		Řadit dle <a n:href="this orderBy => NULL">četnosti</a> | <a n:href="this orderBy => 'lastTime'">času</a>
	</small>

	{form filterForm}
		<table>
		<tr>
			<td>Od</td><td>{input startDate}</td>
			<td>Do</td><td>{input endDate}</td>
			<td>{input onlyActive:}&nbsp;{label onlyActive:}pouze nevyřešené{/label}</td>
			<td>{input send value => "Filtrovat"}</td>
		</tr>
		</table>
	{/form}

	{ifset $data['Fatal Error']}{include #errors, errors => $data['Fatal Error'], label => "Fatal errors", class => "fatal-error"}{/ifset}
	{ifset $data['Warning']}{include #errors, errors => $data['Warning'], label => "Warning", class => "warning"}{/ifset}
	{ifset $data['Deprecated']}{include #errors, errors => $data['Deprecated'], label => "Deprecated", class => "deprecated"}{/ifset}
	{ifset $data['Notice']}{include #errors, errors => $data['Notice'], label => "Notice", class => "notice"}{/ifset}

{/block}

{block errors}

	<div class="section-errors {$class}">
		<h2>{$label}</h2>
		<ul>
			{foreach $errors as $id => $error}
				{var $errorTimeClass = $error['last_time']->format('Ymd') === date('Ymd') ? 'today' : ($error['last_time']->format('Ymd') >= date("Ymd", strtotime('-7 days')) ? 'this-week' : 'older')}
				<li class="message" id="error-{$id}">
					<a class="id" href="#error-{$id}">#{$id}</a>
					<strong>{$error['count']}× {$error['message']}</strong>
					<abbr>&#x25ba;</abbr>
					<br>
					<small>
						{= Tracy\Helpers::editorLink($error['file'], $error['line'])} | <span n:class="$errorTimeClass"> naposledy {$error['last_time']|date:'j. n. Y G:i'}</span>
					</small>
					<p>
						<small n:if="$error['comments']">
						{!nl2br($error['comments'])}
						</small>
						{form commentForm}
							{input errorId value => $id}
							{input newComment}
							{input send}
						{/form}
					</p>
					<small class="to-right">
						{ifset $error['redscreens']}
							{var $redscreens = $error['redscreens']}
							{var $rs = array_shift($redscreens)}
							| <a href="{link viewException, errorId => $id, hash => $rs->hash}" class="redscreen" title="{$rs->time|date:'j. n. Y H:i:s'}">redscreen</a>
							{foreach $redscreens as $rs}
								{if $iterator->first}({/if}{*
								*}<a href="{link viewException, errorId => $id, hash => $rs->hash}" class="redscreen" title="{$rs->time|date:'j. n. Y H:i:s'}">{*
									*}{=$iterator->counter + 1}{*
								*}</a>{*
								*}{if !$iterator->last}, {else}){/if}
							{/foreach}
						{/ifset}
						|
						{if $error->status == 'active'}
							<a n:if="$error->status == 'active'" class="resolve" href="{link markAsResolved!, $id}">označit jako vyřešené</a>
						{else}
							<a n:if="$error->status == 'resolved'" class="resolve reopen" href="{link markAsReopened!, $id}">znovuotevřít</a>
						{/if}
						|
					</small>
				</li>
				<li class="section-errors-urls">
					{* Seznam URL se načítá AJAXem *}
				</li>
			{/foreach}
		</ul>
	</div>

{/block}
